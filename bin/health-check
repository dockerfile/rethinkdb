#!/usr/bin/env python2

import sys
import rethinkdb as r


def is_healthy():
    can_access_status = (
        r.db('rethinkdb')
            .table('server_status')
            .nth(0)
    )

    all_tables_ready = (
        r.db('rethinkdb')
            .table('table_status')
            .get_field('status')
            .concat_map(lambda status: status.values())
            .reduce(r.and_)
            .default(True)
    )

    try:
        conn = r.connect()
        return (can_access_status & all_tables_ready).run(conn)
    except:
        return False


if is_healthy():
    sys.exit(0)
else:
    sys.exit(1)
